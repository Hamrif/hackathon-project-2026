<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingredients - What the fridge?</title>
    <link rel="stylesheet" href="/style.css"> 
</head>
<body class="dashboard-body">

    <nav class="navbar dashboard-nav">
        <div class="navlogo">
            <img src="/asset/logo.jpeg" alt="logo">
        </div>
        <div id="logo">What The Fridge?</div>
    </nav>

    <div class="dashboard-container">
        
        <div class="left-panel">
            
            <div class="input-section">
                <form action="/analyze-image" method="POST" enctype="multipart/form-data" class="wireframe-form">
                    <input type="file" name="image" accept="image/*" required class="wireframe-input" />
                    <button type="submit" class="wireframe-btn">Analyze</button>
                </form>
            </div>

            <div class="input-section">
                <div class="wireframe-form">
                    <input type="text" id="ingredientInput" placeholder="Text input here..." class="wireframe-input">
                    <button type="button" id="addBtn" class="wireframe-btn">Add</button>
                </div>
            </div>

            <div class="list-section">
                <ul id="ingredientList">
                    <% if (typeof ingredients !== 'undefined' && ingredients.length > 0) { %>
                        <% ingredients.forEach(function(item) { %>
                            <li><%= item %> <button class="remove-btn">x</button></li>
                        <% }); %>
                    <% } else { %>
                        <p class="empty-state">No ingredients added yet.</p>
                    <% } %>
                </ul>
            </div>
        </div>

        <div class="right-panel">
            

            <button id="generateRecipeBtn" class="generate-btn">Generate Recipe</button>
        </div>

    </div>
    
    <script>
        const input = document.getElementById('ingredientInput');
        const addBtn = document.getElementById('addBtn');
        const list = document.getElementById('ingredientList');
        const generateBtn = document.getElementById('generateRecipeBtn');

        addBtn.addEventListener('click', () => {
            const value = input.value.trim();
            if (value !== "") {
                addIngredient(value);
                input.value = ''; 
            }
        });

        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addBtn.click();
            }
        });

        function addIngredient(name) {
            const emptyMsg = list.querySelector('.empty-state');
            if(emptyMsg) emptyMsg.remove();

            const li = document.createElement('li');
            li.textContent = name + " ";
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'x';
            removeBtn.className = 'remove-btn';
            
            removeBtn.onclick = function() {
                li.remove();
            };

            li.appendChild(removeBtn);
            list.appendChild(li);
        }

        document.querySelectorAll('.remove-btn').forEach(button => {
            button.onclick = function() {
                this.parentElement.remove();
            };
        });

        if (generateBtn) {
            generateBtn.addEventListener('click', () => {
                const ingredients = [];
                const listItems = list.querySelectorAll('li');
                
                listItems.forEach(li => {
                    // Extract text content, ignoring the button element inside the li
                    let text = '';
                    li.childNodes.forEach(node => {
                        if (node.nodeType === 3) { // Node.TEXT_NODE
                            text += node.textContent;
                        }
                    });
                    const trimmed = text.trim();
                    if (trimmed) ingredients.push(trimmed);
                });

                if (ingredients.length === 0) {
                    alert('Please add ingredients first.');
                    return;
                }

                // Create a hidden form to submit the ingredients to the server
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/get-recipes';
                form.style.display = 'none';

                ingredients.forEach(ing => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'ingredients';
                    input.value = ing;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            });
        }

        // Handle image upload form to preserve existing ingredients
        const uploadForm = document.querySelector('form[action="/analyze-image"]');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function() {
                const listItems = list.querySelectorAll('li');
                listItems.forEach(li => {
                    // Extract text content, ignoring the button element inside the li
                    let text = '';
                    li.childNodes.forEach(node => {
                        if (node.nodeType === 3) { // Node.TEXT_NODE
                            text += node.textContent;
                        }
                    });
                    const trimmed = text.trim();
                    if (trimmed) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'existingIngredients';
                        input.value = trimmed;
                        this.appendChild(input);
                    }
                });
            });
        }
    </script>
</body>
</html>